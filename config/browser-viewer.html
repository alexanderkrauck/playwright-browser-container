<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #2a2a2a;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        #screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
        }
        #status.connected {
            background: rgba(34, 139, 34, 0.8);
        }
        #status.disconnected {
            background: rgba(220, 20, 60, 0.8);
        }
        #status.connecting {
            background: rgba(255, 165, 0, 0.8);
        }
    </style>
    <link rel="stylesheet" href="app/styles/base.css">
    <script type="module">
        import RFB from './core/rfb.js';

        let rfb;
        let statusEl;

        function updateStatus(text, state) {
            statusEl.textContent = text;
            statusEl.className = state;
        }

        function connected(e) {
            updateStatus('Connected', 'connected');
            console.log('Connected to VNC server');
        }

        function disconnected(e) {
            if (e.detail.clean) {
                updateStatus('Disconnected', 'disconnected');
            } else {
                updateStatus('Connection lost', 'disconnected');
            }
            console.log('Disconnected from VNC server');
            // Auto-reconnect after 2 seconds
            setTimeout(connect, 2000);
        }

        function connect() {
            updateStatus('Connecting...', 'connecting');
            
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const host = window.location.host;
            const path = '/browser-viewer/websockify';
            const url = `${protocol}://${host}${path}`;
            
            console.log('Connecting to:', url);
            
            try {
                rfb = new RFB(document.getElementById('screen'), url);
                // Scale the remote 1920x1080 desktop to fit the viewer while
                // keeping the remote session at Full HD resolution.
                rfb.scaleViewport = true;
                rfb.resizeSession = false;
                rfb.showDotCursor = true;
                rfb.viewOnly = false;
                rfb.clipViewport = true;   // Fit within viewport bounds
                rfb.dragViewport = false;  // No need to pan when scaling
                rfb.addEventListener('connect', connected);
                rfb.addEventListener('disconnect', disconnected);
            } catch (err) {
                console.error('Failed to create RFB client:', err);
                updateStatus('Connection failed', 'disconnected');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            statusEl = document.getElementById('status');
            connect();
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (rfb) {
                rfb.scaleViewport = true;
            }
        });
    </script>
</head>
<body>
    <div id="status">Initializing...</div>
    <div id="screen"></div>
</body>
</html>
